#!/usr/bin/env bash
source "$(dirname "$0")/lib.sh"

[[ "${1:-}" == "-h" || "${1:-}" == "--help" ]] && {
    show_help "bench-all" "Compare all nit implementations head-to-head" \
        "bench-all [COMMAND] [WORKERS]

Arguments:
  COMMAND   Git command to benchmark (default: status)
  WORKERS   Number of workers/connections (default: 8)

Examples:
  bench-all              # benchmark 'status' with 8 workers
  bench-all fetch 4      # benchmark 'fetch' with 4 workers"
    exit 0
}

CMD="${1:-status}"
WORKERS="${2:-8}"

IMPLEMENTATIONS=($(discover_implementations))
[[ ${#IMPLEMENTATIONS[@]} -eq 0 ]] && { echo "No implementations found in ${BIN_DIR}"; exit 1; }

echo "=== Benchmarking: nit $CMD (workers=$WORKERS) ==="
echo "Implementations: ${IMPLEMENTATIONS[*]}"
echo

CMDS=()
for impl in "${IMPLEMENTATIONS[@]}"; do
    name=$(basename "$impl")
    CMDS+=("-n" "$name" "$impl -n $WORKERS $CMD")
done

hyperfine --warmup $WARMUP --min-runs $MIN_RUNS "${CMDS[@]}"
