#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_DIR="${SCRIPT_DIR}/../bin"

echo "# Benchmark Results - $(date '+%Y-%m-%d')"
echo
echo "## Environment"
echo
echo "* $(uname -s) $(uname -r)"
echo "* $(sysctl -n hw.ncpu 2>/dev/null || nproc) CPU cores"
echo

# Discover available implementations
IMPLS=()
for impl in "${BIN_DIR}"/nit-*; do
    [[ -x "$impl" ]] && IMPLS+=("$(basename "$impl" | sed 's/nit-//')")
done

echo "* Implementations: ${IMPLS[*]}"
echo

for cmd in status fetch; do
    echo "## $cmd - Head to Head"
    echo
    echo '```'
    "$SCRIPT_DIR/bench-all" "$cmd" 8 2>&1
    echo '```'
    echo
done

echo "## Worker Scaling (status)"
echo
for impl in "${IMPLS[@]}"; do
    echo "### nit-${impl}"
    echo
    echo '```'
    "$SCRIPT_DIR/bench-scaling" "$impl" status "1,2,4,8" 2>&1
    echo '```'
    echo
done
