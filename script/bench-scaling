#!/usr/bin/env bash
source "$(dirname "$0")/lib.sh"

[[ "${1:-}" == "-h" || "${1:-}" == "--help" ]] && {
    show_help "bench-scaling" "Test how performance scales with worker count" \
        "bench-scaling [IMPL] [COMMAND] [WORKERS]

Arguments:
  IMPL      Implementation to test (default: rust)
  COMMAND   Git command to benchmark (default: status)
  WORKERS   Comma-separated worker counts (default: 1,2,4,8,12,16)

Examples:
  bench-scaling                        # test rust status scaling
  bench-scaling rust fetch 1,2,4,8     # test fetch with specific workers"
    exit 0
}

IMPL="${1:-rust}"
CMD="${2:-status}"
WORKERS="${3:-1,2,4,8,12,16}"

NIT="${BIN_DIR}/nit-${IMPL}"

if [[ ! -x "$NIT" ]]; then
    echo "Implementation not found: $NIT"
    echo "Available: $(discover_impl_names | tr '\n' ' ')"
    exit 1
fi

echo "=== Worker Scaling: nit-${IMPL} $CMD ==="
echo "Workers: $WORKERS"
echo

hyperfine \
    --warmup $WARMUP \
    --min-runs $MIN_RUNS \
    -L workers "$WORKERS" \
    "$NIT -n {workers} $CMD"
